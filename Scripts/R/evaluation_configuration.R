################################################################################
# EVALUATION CONFIGURATION
#
# Logic:
# 1. Load the "Truth" (True Variables & Betas) from CSV files generated by simulation.
# 2. Define outcome ratios for reference.
# 3. Save a consolidated RData file for downstream evaluation scripts.
#
################################################################################

library(dplyr)

# ============================================================================
# 1. OUTCOME RATIOS
# ============================================================================

outcome_ratios <- list(
  MIMIC = list(
    real = list(zeros_pct = 64.29, ones_pct = 35.71),
    simulated = list(
      MCAR = list(zeros_pct = 63.1, ones_pct = 36.9),
      MAR  = list(zeros_pct = 62.5, ones_pct = 37.5),
      MNAR = list(zeros_pct = 61.9, ones_pct = 38.1)
    )
  ),
  MI = list(
    real = list(zeros_pct = 76.81, ones_pct = 23.19),
    simulated = list(
      MCAR = list(zeros_pct = 63.6, ones_pct = 36.4),
      MAR  = list(zeros_pct = 74.3, ones_pct = 25.7),
      MNAR = list(zeros_pct = 76.1, ones_pct = 23.9)
    )
  )
)

# ============================================================================
# 2. LOAD TRUE VARIABLES
# ============================================================================

load_true_variables <- function(dataset, mechanism) {
  filename <- paste0("Data/", dataset, "_", mechanism, "_true_variables.csv")
  
  if (!file.exists(filename)) {
    warning(paste("File not found:", filename))
    return(NULL)
  }
  
  info <- read.csv(filename)
  return(list(
    variables = info$variable,
    betas = info$beta_true,
    missingness_rates = info$missingness_rate
  ))
}

true_variables <- list()
beta_true_values <- list()

datasets <- c("MIMIC", "MI")
mechanisms <- c("MCAR", "MAR", "MNAR")

cat("Loading True Variables configuration...\n")

for (ds in datasets) {
  for (mech in mechanisms) {
    key <- paste0(ds, "_", mech)
    data <- load_true_variables(ds, mech)
    
    if (!is.null(data)) {
      true_variables[[key]] <- data$variables
      beta_true_values[[key]] <- data$betas
      cat(sprintf("  Loaded %s: %d vars\n", key, length(data$variables)))
    }
  }
}

# ============================================================================
# 3. SAVE CONFIGURATION
# ============================================================================

save(true_variables, beta_true_values, outcome_ratios, file = "Data/evaluation_config_4VAR.RData")
cat("\nSaved configuration to 'evaluation_config_4VAR.RData'.\n")

# Save detailed CSV summary
summary_df <- data.frame()
for (key in names(true_variables)) {
  parts <- strsplit(key, "_")[[1]]
  ds <- parts[1]
  mech <- parts[2]
  
  vars <- true_variables[[key]]
  betas <- beta_true_values[[key]]
  
  for (i in seq_along(vars)) {
    summary_df <- rbind(summary_df, data.frame(
      Dataset = ds,
      Mechanism = mech,
      Variable = vars[i],
      Beta = betas[i],
      Rank = i
    ))
  }
}

write.csv(summary_df, "Data/evaluation_config_summary_4VAR.csv", row.names = FALSE)
cat("Saved summary to 'evaluation_config_summary_4VAR.csv'.\n")
